extends Node2D

const TILE_SIZE := 16

# Level layout: # = solid, . = empty
# Viewport is 40x25 tiles (640x400), this map is ~100 tiles wide for scrolling
const LEVEL_MAP := [
	"####################################################################################################",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"#..............####...........................................................######...............#",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"#.........####..........####..............########.............................####................#",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"#...####..............####..............####..........####.............####........................#",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"#..................................####..........####..........####..........####..................#",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"#..................................................................................................#",
	"####################################################################################################",
	"####################################################################################################",
]

var tilemap_layer: TileMapLayer

func _ready() -> void:
	_build_tilemap()

func _build_tilemap() -> void:
	tilemap_layer = TileMapLayer.new()

	var tileset := TileSet.new()
	tileset.tile_size = Vector2i(TILE_SIZE, TILE_SIZE)

	# Create a TileSetAtlasSource with a single-pixel image we'll color
	var source := TileSetAtlasSource.new()
	var img := Image.create(TILE_SIZE, TILE_SIZE, false, Image.FORMAT_RGBA8)
	img.fill(Color(0.35, 0.35, 0.45))
	source.texture = ImageTexture.create_from_image(img)
	source.texture_region_size = Vector2i(TILE_SIZE, TILE_SIZE)
	source.create_tile(Vector2i(0, 0))

	var source_id := tileset.add_source(source)

	# Add physics layer to tileset so tiles have collision
	tileset.add_physics_layer()
	# Create collision polygon for the tile (coordinates are relative to tile center)
	var half := TILE_SIZE / 2.0
	var polygon := PackedVector2Array([
		Vector2(-half, -half), Vector2(half, -half),
		Vector2(half, half), Vector2(-half, half)
	])
	source.get_tile_data(Vector2i(0, 0), 0).add_collision_polygon(0)
	source.get_tile_data(Vector2i(0, 0), 0).set_collision_polygon_points(0, 0, polygon)

	tilemap_layer.tile_set = tileset
	add_child(tilemap_layer)

	# Place tiles from the map
	for y in range(LEVEL_MAP.size()):
		var row: String = LEVEL_MAP[y]
		for x in range(row.length()):
			if row[x] == "#":
				tilemap_layer.set_cell(Vector2i(x, y), source_id, Vector2i(0, 0))
